<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Pyro Logger">
    <meta name="description" content="Weekly Pyrotechnic Work Experience Log for Joint Industry SFX Grading Scheme">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pyro Logger">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="msapplication-TileImage" content="icons/icon-144.png">
    
    <title>Pyro Logger</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2937;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #374151;
            --danger: #ef4444;
            --success: #22c55e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 0.9rem;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group.small {
            flex: 0 0 200px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .char-count {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .char-count.warning {
            color: #f59e0b;
        }
        
        .char-count.error {
            color: var(--danger);
        }
        
        .radio-group {
            display: flex;
            gap: 24px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .radio-option input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .day-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .day-option input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .day-option span {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .saved-entries {
            margin-top: 32px;
        }
        
        .saved-entries h2 {
            margin-bottom: 16px;
        }
        
        .entry-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .entry-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .entry-meta {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .entry-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
            }
            .form-group.small {
                flex: 1;
            }
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
            .days-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .btn-row {
                flex-direction: column;
            }
            .container {
                padding: 10px;
            }
            .card {
                padding: 16px;
            }
            h1 {
                font-size: 1.2rem;
            }
            .entry-header {
                flex-direction: column;
                gap: 12px;
            }
            .entry-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* ========================================
           INSTALLER LANDING PAGE STYLES
           ======================================== */
        
        /* Display mode detection - browser shows installer, standalone shows app */
        #app { display: none; }
        #installer { display: flex; }
        
        @media (display-mode: standalone) {
            #app { display: block; }
            #installer { display: none !important; }
        }
        
        /* iOS standalone detection fallback */
        @media (display-mode: fullscreen) {
            #app { display: block; }
            #installer { display: none !important; }
        }
        
        /* Installer layout */
        #installer {
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        .installer-content {
            max-width: 400px;
            width: 100%;
        }
        
        .app-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.3);
        }
        
        .app-icon img {
            width: 100%;
            height: 100%;
            border-radius: 24px;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .app-tagline {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }
        
        .install-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .install-btn.btn-ios {
            background: #333;
            color: #fff;
        }
        
        .install-btn.btn-android {
            background: #3ddc84;
            color: #000;
        }
        
        .already-installed {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 24px;
        }
        
        /* Instructions screens */
        .instructions-screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
        }
        
        .instructions-screen.active {
            display: block;
        }
        
        .instructions-header {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 0;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .instructions-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .instructions-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }
        
        .step {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }
        
        .step-num {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .step-num-ios {
            background: #007aff;
            color: #fff;
        }
        
        .step-num-android {
            background: #3ddc84;
            color: #000;
        }
        
        .step-content {
            flex: 1;
            padding-top: 6px;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .step-desc {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .step-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-card);
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
        }
        
        /* Desktop view */
        .desktop-message {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
        
        .desktop-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }
        
        .desktop-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .desktop-msg {
            color: var(--text-secondary);
            max-width: 320px;
            line-height: 1.5;
            margin-bottom: 24px;
        }
        
        .qr-code {
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .qr-url {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Hide mobile installer on desktop, show desktop message */
        @media (min-width: 768px) and (hover: hover) {
            #installer .installer-content,
            #installer .instructions-screen {
                display: none !important;
            }
            #installer .desktop-message {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- ========================================
         INSTALLER LANDING PAGE
         Only shown when accessed in browser (not standalone PWA)
         ======================================== -->
    <div id="installer">
        <!-- Landing Screen -->
        <div class="installer-content" id="installer-landing">
            <div class="app-icon">
                <img src="icons/icon-192.png" alt="Pyro Logger">
            </div>
            <h1 class="app-title">Pyro Logger</h1>
            <p class="app-tagline">Work logging for pyrotechnicians</p>
            
            <button class="install-btn btn-ios" onclick="showScreen('ios-instructions')">
                <span></span>
                Install on iPhone/iPad
            </button>
            
            <button class="install-btn btn-android" onclick="showScreen('android-instructions')">
                <span>ü§ñ</span>
                Install on Android
            </button>
            
            <p class="already-installed">
                Already installed? Open from your home screen.
            </p>
        </div>
        
        <!-- iOS Instructions Screen -->
        <div class="instructions-screen" id="ios-instructions">
            <div class="instructions-header">
                <button class="back-btn" onclick="showScreen('installer-landing')">‚Üê Back</button>
                <h2 class="instructions-title">Install on iPhone/iPad</h2>
                <p class="instructions-subtitle">Follow these steps to add Pyro Logger to your home screen</p>
            </div>
            
            <div class="step">
                <div class="step-num step-num-ios">1</div>
                <div class="step-content">
                    <div class="step-title">Tap the Share button</div>
                    <div class="step-desc">Find it at the bottom of your Safari browser</div>
                    <div class="step-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v13M19 9l-7-7-7 7M5 21h14"/>
                        </svg>
                        Share
                    </div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-ios">2</div>
                <div class="step-content">
                    <div class="step-title">Scroll down and tap "Add to Home Screen"</div>
                    <div class="step-desc">You may need to scroll to find this option</div>
                    <div class="step-icon">‚ûï Add to Home Screen</div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-ios">3</div>
                <div class="step-content">
                    <div class="step-title">Tap "Add" in the top right</div>
                    <div class="step-desc">The app name will be "Pyro Logger"</div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-ios">4</div>
                <div class="step-content">
                    <div class="step-title">Open from your home screen</div>
                    <div class="step-desc">Find the Pyro Logger icon and tap to open</div>
                </div>
            </div>
        </div>
        
        <!-- Android Instructions Screen -->
        <div class="instructions-screen" id="android-instructions">
            <div class="instructions-header">
                <button class="back-btn" onclick="showScreen('installer-landing')">‚Üê Back</button>
                <h2 class="instructions-title">Install on Android</h2>
                <p class="instructions-subtitle">Follow these steps to add Pyro Logger to your home screen</p>
            </div>
            
            <div class="step">
                <div class="step-num step-num-android">1</div>
                <div class="step-content">
                    <div class="step-title">Tap the menu button</div>
                    <div class="step-desc">Look for ‚ãÆ (three dots) in Chrome's top right corner</div>
                    <div class="step-icon">‚ãÆ Menu</div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-android">2</div>
                <div class="step-content">
                    <div class="step-title">Tap "Install app" or "Add to Home screen"</div>
                    <div class="step-desc">The wording varies by browser version</div>
                    <div class="step-icon">üì≤ Install app</div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-android">3</div>
                <div class="step-content">
                    <div class="step-title">Confirm the installation</div>
                    <div class="step-desc">Tap "Install" when prompted</div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num step-num-android">4</div>
                <div class="step-content">
                    <div class="step-title">Open from your home screen</div>
                    <div class="step-desc">Find the Pyro Logger icon and tap to open</div>
                </div>
            </div>
        </div>
        
        <!-- Desktop Message -->
        <div class="desktop-message">
            <div class="desktop-icon">üì±</div>
            <h2 class="desktop-title">Mobile App Only</h2>
            <p class="desktop-msg">
                Pyro Logger is designed for mobile devices. Scan the QR code with your phone to install.
            </p>
            <img class="qr-code" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://thegdyne.github.io/pyro-logger/" alt="QR Code to Pyro Logger">
            <p class="qr-url">thegdyne.github.io/pyro-logger</p>
        </div>
    </div>
    
    <!-- ========================================
         MAIN APP
         Only shown when running as installed PWA (standalone mode)
         ======================================== -->
    <div id="app">
    <div class="container">
        <h1>Weekly Pyrotechnic Work Experience Log</h1>
        <p class="subtitle">Joint Industry SFX Grading Scheme</p>
        
        <!-- Form -->
        <div class="card">
            <h2>Operator Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" maxlength="100">
                </div>
                <div class="form-group small">
                    <label for="date">Week Ending (Sunday)</label>
                    <input type="date" id="date">
                </div>
            </div>
            
            <div class="form-group">
                <label>Grade</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="grade" value="trainee">
                        <span>Trainee</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="grade" value="technician">
                        <span>Technician</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="grade" value="senior">
                        <span>Senior Technician</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Production Details</h2>
            <div class="form-group">
                <label for="company">Name of Production Company</label>
                <input type="text" id="company" maxlength="100">
            </div>
            <div class="form-group">
                <label for="title">Film/Programme Title</label>
                <input type="text" id="title" maxlength="100">
            </div>
            <div class="form-group">
                <label for="country">Country Working In</label>
                <input type="text" id="country" maxlength="100">
            </div>
            <div class="form-group">
                <label for="supervisor">Name of Pyrotechnic Supervisor</label>
                <input type="text" id="supervisor" maxlength="100">
            </div>
        </div>
        
        <div class="card">
            <h2>Days Involving Pyrotechnics</h2>
            <div class="days-grid">
                <label class="day-option"><span>MON</span><input type="checkbox" name="day" value="mon"></label>
                <label class="day-option"><span>TUES</span><input type="checkbox" name="day" value="tues"></label>
                <label class="day-option"><span>WED</span><input type="checkbox" name="day" value="wed"></label>
                <label class="day-option"><span>THURS</span><input type="checkbox" name="day" value="thurs"></label>
                <label class="day-option"><span>FRI</span><input type="checkbox" name="day" value="fri"></label>
                <label class="day-option"><span>SAT</span><input type="checkbox" name="day" value="sat"></label>
                <label class="day-option"><span>SUN</span><input type="checkbox" name="day" value="sun"></label>
            </div>
        </div>
        
        <div class="card">
            <h2>Work Description</h2>
            <div class="form-group">
                <label for="effect">Describe Effect Required</label>
                <textarea id="effect" maxlength="500"></textarea>
                <div class="char-count" id="effect-count">0 / 500</div>
            </div>
            <div class="form-group">
                <label for="explosives">Type, Make and Amount of Explosives/Pyrotechnics Used</label>
                <textarea id="explosives" maxlength="500"></textarea>
                <div class="char-count" id="explosives-count">0 / 500</div>
            </div>
            <div class="form-group">
                <label for="involvement">Your Involvement in Handling and Type of Work Carried Out</label>
                <textarea id="involvement" maxlength="500"></textarea>
                <div class="char-count" id="involvement-count">0 / 500</div>
            </div>
        </div>
        
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="saveEntry()">Save Entry</button>
            <button class="btn btn-primary" id="generateBtn" onclick="generatePDF()">Generate PDF</button>
        </div>
        
        <!-- Saved Entries -->
        <div class="saved-entries card">
            <h2>Saved Entries</h2>
            <div id="entriesList"></div>
        </div>
    </div>
    </div> <!-- end #app -->

    <!-- jsPDF library embedded -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Date input - no auto-adjustment, user picks the week-ending Sunday themselves
        
        // Character counters
        ['effect', 'explosives', 'involvement'].forEach(id => {
            const textarea = document.getElementById(id);
            const counter = document.getElementById(id + '-count');
            textarea.addEventListener('input', function() {
                const len = this.value.length;
                counter.textContent = `${len} / 500`;
                counter.className = 'char-count' + (len > 450 ? (len >= 500 ? ' error' : ' warning') : '');
            });
        });
        
        // Get form data
        function getFormData() {
            return {
                name: document.getElementById('name').value,
                date: document.getElementById('date').value,
                grade: document.querySelector('input[name="grade"]:checked')?.value || '',
                company: document.getElementById('company').value,
                title: document.getElementById('title').value,
                country: document.getElementById('country').value,
                supervisor: document.getElementById('supervisor').value,
                days: Array.from(document.querySelectorAll('input[name="day"]:checked')).map(cb => cb.value),
                effect: document.getElementById('effect').value,
                explosives: document.getElementById('explosives').value,
                involvement: document.getElementById('involvement').value,
                savedAt: new Date().toISOString()
            };
        }
        
        // Load form data
        function loadFormData(data) {
            document.getElementById('name').value = data.name || '';
            document.getElementById('date').value = data.date || '';
            document.getElementById('company').value = data.company || '';
            document.getElementById('title').value = data.title || '';
            document.getElementById('country').value = data.country || '';
            document.getElementById('supervisor').value = data.supervisor || '';
            document.getElementById('effect').value = data.effect || '';
            document.getElementById('explosives').value = data.explosives || '';
            document.getElementById('involvement').value = data.involvement || '';
            
            // Grade
            document.querySelectorAll('input[name="grade"]').forEach(r => r.checked = r.value === data.grade);
            
            // Days
            document.querySelectorAll('input[name="day"]').forEach(cb => {
                cb.checked = (data.days || []).includes(cb.value);
            });
            
            // Update counters
            ['effect', 'explosives', 'involvement'].forEach(id => {
                const textarea = document.getElementById(id);
                textarea.dispatchEvent(new Event('input'));
            });
        }
        
        // LocalStorage
        function getEntries() {
            return JSON.parse(localStorage.getItem('pyroLogEntries') || '[]');
        }
        
        function saveEntries(entries) {
            localStorage.setItem('pyroLogEntries', JSON.stringify(entries));
        }
        
        function saveEntry() {
            const data = getFormData();
            const entries = getEntries();
            
            // Use date+name as unique key, update if exists
            const key = `${data.date}-${data.name}`;
            const existingIndex = entries.findIndex(e => `${e.date}-${e.name}` === key);
            
            if (existingIndex >= 0) {
                entries[existingIndex] = data;
            } else {
                entries.unshift(data);
            }
            
            saveEntries(entries);
            renderEntries();
            alert('Entry saved!');
        }
        
        function loadEntry(index) {
            const entries = getEntries();
            if (entries[index]) {
                loadFormData(entries[index]);
            }
        }
        
        function deleteEntry(index) {
            if (confirm('Delete this entry?')) {
                const entries = getEntries();
                entries.splice(index, 1);
                saveEntries(entries);
                renderEntries();
            }
        }
        
        function renderEntries() {
            const entries = getEntries();
            const container = document.getElementById('entriesList');
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved entries yet</div>';
                return;
            }
            
            container.innerHTML = entries.map((e, i) => `
                <div class="entry-card">
                    <div class="entry-header">
                        <div>
                            <div class="entry-title">${e.name || 'Unnamed'}</div>
                            <div class="entry-meta">${e.company || 'No company'} ‚Äî ${e.supervisor || 'No supervisor'}</div>
                            <div class="entry-meta">${e.date || 'No date'} ‚Ä¢ ${e.grade || 'No grade'}</div>
                        </div>
                        <div class="entry-actions">
                            <button class="btn btn-small btn-secondary" onclick="loadEntry(${i})">Load</button>
                            <button class="btn btn-small btn-primary" onclick="generatePDFForEntry(${i})">PDF</button>
                            <button class="btn btn-small btn-danger" onclick="deleteEntry(${i})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function generatePDFForEntry(index) {
            const entries = getEntries();
            if (entries[index]) {
                loadFormData(entries[index]);
                setTimeout(generatePDF, 100);
            }
        }
        
        /**
         * PDF Generation - Evidence-Based Layout
         * 
         * Based on analysis of WeeklyPyrotechnicLog_4.pdf:
         * - Page: 612 x 792 points (US Letter)
         * - Input boxes: ~21pt height
         * - Checkboxes: 11.5 x 11.5 pt
         * - Left margin: ~66pt
         * - Right edge: ~546pt
         */
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const data = getFormData();
            
            // Create PDF in points, US Letter size
            const doc = new jsPDF({
                unit: 'pt',
                format: 'letter' // 612 x 792 pt
            });
            
            const pageWidth = 612;
            const pageHeight = 792;
            const leftMargin = 66;
            const rightMargin = 546;
            const contentWidth = rightMargin - leftMargin;
            
            // Fonts
            const fontSizeTitle = 14;
            const fontSizeNormal = 12;
            const fontSizeSmall = 10;
            
            // Measurements from analysis
            const inputBoxHeight = 21;
            const checkboxSize = 11.5;
            
            let y = 50;
            
            // === PAGE 1 ===
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(fontSizeTitle);
            doc.text('JOINT INDUSTRY SFX GRADING SCHEME', pageWidth / 2, y, { align: 'center' });
            y += 20;
            doc.text('WEEKLY PYROTECHNIC WORK EXPERIENCE LOG', pageWidth / 2, y, { align: 'center' });
            y += 30;
            
            // NAME and DATE row
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(fontSizeNormal);
            
            // NAME field
            doc.text('NAME:', leftMargin, y + 14);
            drawInputBox(doc, 112, y, 170, inputBoxHeight, data.name);
            
            // DATE field
            doc.text('DATE (end Sunday of week worked):', 290, y + 14);
            const formattedDate = data.date ? formatDate(data.date) : '';
            drawInputBox(doc, 488, y, 62, inputBoxHeight, formattedDate);
            y += 35;
            
            // GRADE section
            doc.text('GRADE at which this work was carried out (put a cross in the appropriate box):', leftMargin, y);
            y += 20;
            
            // Grade options - labels above checkboxes
            const gradeOptions = [
                { label: 'TRAINEE', x: 120, value: 'trainee' },
                { label: 'TECHNICIAN', x: 250, value: 'technician' },
                { label: 'SENIOR TECHNICIAN', x: 400, value: 'senior' }
            ];
            
            gradeOptions.forEach(opt => {
                doc.setFontSize(fontSizeNormal);
                doc.text(opt.label, opt.x, y);
                drawCheckbox(doc, opt.x + 20, y + 8, checkboxSize, data.grade === opt.value);
            });
            y += 40;
            
            // Production details
            const productionFields = [
                { label: 'NAME OF PRODUCTION COMPANY:', value: data.company },
                { label: 'FILM/PROGRAMME TITLE:', value: data.title },
                { label: 'COUNTRY WORKING IN:', value: data.country },
                { label: 'NAME OF PYROTECHNIC SUPERVISOR:', value: data.supervisor }
            ];
            
            productionFields.forEach(field => {
                doc.setFontSize(fontSizeNormal);
                doc.text(field.label, leftMargin, y + 14);
                drawInputBox(doc, 315, y, 235, inputBoxHeight, field.value);
                y += 28;
            });
            
            y += 10;
            
            // Days section
            doc.text('DAYS INVOLVING PYROTECHNICS (place a cross in the appropriate boxes):', leftMargin, y);
            y += 15;
            
            // Days grid - dark header row
            const daysLabels = ['MON', 'TUES', 'WED', 'THURS', 'FRI', 'SAT', 'SUN'];
            const daysValues = ['mon', 'tues', 'wed', 'thurs', 'fri', 'sat', 'sun'];
            const dayColWidth = contentWidth / 7;
            const gridX = leftMargin;
            
            // Header row with dark background
            doc.setFillColor(80, 80, 80);
            doc.rect(gridX, y, contentWidth, 18, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(fontSizeSmall);
            
            daysLabels.forEach((day, i) => {
                const cellX = gridX + i * dayColWidth;
                doc.text(day, cellX + dayColWidth / 2, y + 12, { align: 'center' });
            });
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            y += 18;
            
            // Checkbox row
            doc.rect(gridX, y, contentWidth, 20);
            daysValues.forEach((day, i) => {
                const cellX = gridX + i * dayColWidth;
                doc.rect(cellX, y, dayColWidth, 20);
                drawCheckbox(doc, cellX + (dayColWidth - checkboxSize) / 2, y + 4, checkboxSize, data.days.includes(day));
            });
            y += 35;
            
            // Effect description
            doc.setFontSize(fontSizeNormal);
            doc.text('Describe Effect required:', leftMargin, y);
            y += 5;
            drawTextArea(doc, leftMargin, y, contentWidth, 80, data.effect);
            y += 95;
            
            // Explosives used
            doc.text('Please state type, make and amount of explosives and pyrotechnics used:', leftMargin, y);
            y += 5;
            drawTextArea(doc, leftMargin, y, contentWidth, 205, data.explosives);
            
            // === PAGE 2 ===
            doc.addPage();
            y = 50;
            
            // Involvement description
            doc.setFontSize(fontSizeNormal);
            doc.text('Describe in brief detail your involvement in handling the above explosives and the type', leftMargin, y);
            y += 14;
            doc.text('of work carried out:', leftMargin, y);
            y += 5;
            drawTextArea(doc, leftMargin, y, contentWidth, 100, data.involvement);
            y += 115;
            
            // Confirmation statement
            doc.text('I confirm that the above information is an accurate record of the applicants\' pyrotechnic', leftMargin, y);
            y += 14;
            doc.text('work for the week as dated above.', leftMargin, y);
            y += 25;
            
            // DATE and SIGNED row
            doc.text('DATE:', leftMargin, y + 14);
            drawInputBox(doc, 134, y, 210, inputBoxHeight, '');
            y += 30;
            
            doc.text('SIGNED:', leftMargin, y + 14);
            drawInputBox(doc, 134, y, 210, inputBoxHeight, '');
            doc.text('PYRO SUPERVISOR/SNR TECH', 355, y + 14);
            y += 35;
            
            // Note - more space above to avoid SIGNED box overlap
            doc.setFontSize(fontSizeSmall);
            doc.text('(NOTE: Only valid when signed by an accredited Pyrotechnics Supervisor/Snr Tech*)', leftMargin, y);
            y += 18;
            
            // Comments box
            doc.setFontSize(fontSizeNormal);
            doc.text('COMMENTS:', leftMargin, y);
            y += 5;
            drawTextArea(doc, leftMargin, y, contentWidth, 60, '');
            y += 75;
            
            // Applicant note
            doc.setFontSize(fontSizeSmall);
            doc.setFont('helvetica', 'bold');
            doc.text('To The Applicant:', leftMargin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(' This is the only form that will be considered when you apply for re-', leftMargin + 85, y);
            y += 12;
            doc.text('grading. Keep them clean and tidy in a loose-leaf binder. Photocopy this form if you', leftMargin, y);
            y += 12;
            doc.text('require more copies, make sure you copy both sides onto ', leftMargin, y);
            doc.setFont('helvetica', 'bold');
            const oneX = leftMargin + 270;
            doc.text('one', oneX, y);
            // Draw underline beneath "one"
            const oneWidth = doc.getTextWidth('one');
            doc.setLineWidth(0.5);
            doc.line(oneX, y + 2, oneX + oneWidth, y + 2);
            doc.setFont('helvetica', 'normal');
            doc.text(' sheet.', oneX + oneWidth + 5, y);  // Proper spacing after underlined word
            y += 20;
            
            // Asterisk notes
            doc.text('*If you are working for a Supervisor who is not registered by the Joint Industry SFX', leftMargin, y);
            y += 12;
            doc.text('Grading Scheme then this form must also be signed by the Production Manager and 1st', leftMargin, y);
            y += 12;
            doc.text('Assistant Director.', leftMargin, y);
            y += 20;
            
            doc.setFont('helvetica', 'bold');
            doc.text('*To Production Managers and 1st Assistant:', leftMargin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(' This form is important, you are signing', leftMargin + 215, y);
            y += 12;
            doc.text('your confirmation that the pyrotechnic effect(s) referred to were carried out and that the', leftMargin, y);
            y += 12;
            doc.text('named pyrotechnics operator worked in a safe manner.', leftMargin, y);
            y += 25;
            
            // PM and 1st AD signature rows - fixed text spacing
            doc.setFontSize(fontSizeNormal);
            doc.text('Production Manager ', leftMargin, y + 14);
            doc.setFont('helvetica', 'italic');
            doc.text('(print name):', leftMargin + 110, y + 14);  // More gap after "Manager"
            doc.setFont('helvetica', 'normal');
            drawInputBox(doc, 270, y, 100, inputBoxHeight, '');   // Moved right
            doc.text('Signed:', 380, y + 14);                     // Gap before box
            drawInputBox(doc, 425, y, 120, inputBoxHeight, '');   // Moved right
            y += 28;
            
            doc.text('1st Assistant Director ', leftMargin, y + 14);
            doc.setFont('helvetica', 'italic');
            doc.text('(print name):', leftMargin + 118, y + 14);  // More gap after "Director"
            doc.setFont('helvetica', 'normal');
            drawInputBox(doc, 270, y, 100, inputBoxHeight, '');   // Aligned with PM row
            doc.text('Signed:', 380, y + 14);                     // Consistent with PM row
            drawInputBox(doc, 425, y, 120, inputBoxHeight, '');   // Aligned with PM row
            y += 35;
            
            // Final comments - add extra spacing to avoid overlap
            doc.text('COMMENTS:', leftMargin, y);
            y += 15;
            drawTextArea(doc, leftMargin, y, contentWidth, 50, '');
            
            // Footer
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text('SM ‚Äì November 2005', rightMargin, 770, { align: 'right' });
            
            // Save - cross-platform with native app support
            const safeName = (data.name || 'unknown').replace(/[^a-zA-Z0-9]/g, '-').substring(0, 20);
            const safeDate = data.date || 'undated';
            const time = new Date().toTimeString().slice(0,5).replace(':', '');
            const filename = `PyroLog-${safeName}-${safeDate}-${time}.pdf`;
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            const pdfBlob = doc.output('blob');
            
            // Check if running as native app (Capacitor)
            if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                try {
                    const { Filesystem, Directory } = await import('https://esm.run/@capacitor/filesystem');
                    const { Share } = await import('https://esm.run/@capacitor/share');
                    
                    // Write file
                    const writeResult = await Filesystem.writeFile({
                        path: filename,
                        data: pdfBase64,
                        directory: Directory.Cache,
                    });
                    
                    // Share it (opens iOS/Android share sheet)
                    await Share.share({
                        title: 'Pyro Work Log',
                        url: writeResult.uri,
                    });
                } catch (err) {
                    console.error('Native save error:', err);
                    // Fallback to blob download
                    doc.save(filename);
                    alert(`PDF saved: ${filename}`);
                }
            } else {
                // Web browser - use appropriate method
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                if (isIOS && navigator.share && navigator.canShare) {
                    const file = new File([pdfBlob], filename, { type: 'application/pdf' });
                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: 'Pyro Work Log' });
                        } catch (err) {
                            if (err.name !== 'AbortError') fallbackIOSSave(doc, filename);
                        }
                    } else {
                        fallbackIOSSave(doc, filename);
                    }
                } else {
                    doc.save(filename);
                    alert(`PDF saved: ${filename}`);
                }
            }
            
            // Auto-save entry
            saveEntry();
        }
        
        function fallbackIOSSave(doc, filename) {
            // Fallback for iOS: open PDF in new tab
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Create a visible link the user can tap
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;padding:24px;border-radius:12px;text-align:center;max-width:300px;">
                    <h3 style="margin:0 0 16px;color:#333;">PDF Ready</h3>
                    <p style="margin:0 0 20px;color:#666;font-size:14px;">Tap the button below to open your PDF, then use the Share button to save it.</p>
                    <a href="${pdfUrl}" target="_blank" style="display:block;background:#3b82f6;color:white;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:12px;">Open PDF</a>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#666;font-size:14px;cursor:pointer;">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Helper: Draw input box with optional text - FIXED for visible borders
        function drawInputBox(doc, x, y, width, height, text) {
            doc.setDrawColor(0, 0, 0);  // Explicitly black
            doc.setLineWidth(1);  // Thicker line for visibility
            doc.rect(x, y, width, height, 'S');  // 'S' = stroke only
            if (text) {
                doc.setFontSize(11);
                doc.text(text, x + 3, y + 14);
            }
        }
        
        // Helper: Draw checkbox - consistent visible borders
        function drawCheckbox(doc, x, y, size, checked) {
            doc.setDrawColor(0, 0, 0);  // Explicitly black
            doc.setLineWidth(1);  // Consistent with input boxes
            doc.rect(x, y, size, size, 'S');
            if (checked) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('X', x + 2.5, y + 9);
                doc.setFont('helvetica', 'normal');
            }
        }
        
        // Helper: Draw text area box with wrapped text - consistent visible borders
        function drawTextArea(doc, x, y, width, height, text) {
            doc.setDrawColor(0, 0, 0);  // Explicitly black
            doc.setLineWidth(1);  // Consistent with other boxes
            doc.rect(x, y, width, height, 'S');
            if (text) {
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(text, width - 10);
                const maxLines = Math.floor((height - 10) / 12);
                doc.text(lines.slice(0, maxLines), x + 5, y + 12);
            }
        }
        
        // Helper: Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB');
        }
        
        // Init
        renderEntries();
    </script>
    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    
    <!-- Installer Navigation -->
    <script>
        // Screen navigation for installer
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.installer-content, .instructions-screen').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            
            // Show requested screen
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.style.display = 'block';
                screen.classList.add('active');
            }
        }
        
        // iOS standalone detection (fallback for older iOS)
        if (window.navigator.standalone === true) {
            document.getElementById('installer').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }
        
        // Android: Try to trigger native install prompt
        let deferredInstallPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            
            // Update Android button to use native prompt
            const androidBtn = document.querySelector('.btn-android');
            if (androidBtn) {
                androidBtn.onclick = async () => {
                    if (deferredInstallPrompt) {
                        deferredInstallPrompt.prompt();
                        const result = await deferredInstallPrompt.userChoice;
                        if (result.outcome === 'accepted') {
                            console.log('PWA installed via prompt');
                        }
                        deferredInstallPrompt = null;
                    } else {
                        showScreen('android-instructions');
                    }
                };
            }
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    console.log('SW registered:', registration.scope);
                    
                    // Check for updates periodically
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('SW update found');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content available, show update prompt
                                if (confirm('A new version of Pyro Logger is available. Reload to update?')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('SW registration failed:', error);
                }
            });
            
            // Handle controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('SW controller changed');
            });
        }
        
        // PWA Install Prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Could show a custom install button here
            // For now, just log that install is available
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
